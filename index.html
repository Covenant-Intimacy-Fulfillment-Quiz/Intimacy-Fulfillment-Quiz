<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Discover Your Top Intimacy Needs</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #fff9f2; color: #1a3c5e; max-width: 800px; margin: auto; padding: 20px; }
    h1,h2,h3 { text-align: center; }
    .branding { text-align: center; font-size: 0.85em; color: #888; margin-top: 20px; }
    .question { display: none; }
    .question.active { display: block; }
    .progress { text-align: center; margin: 20px 0; font-weight: bold; color: #888; }
    label { display: block; margin: 10px 0; padding: 10px 15px; background: #f5f5f5; border-radius: 5px; cursor: pointer; }
    input[type="radio"] { margin-right: 10px; }
    button { background: #4d9de0; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 5px; cursor: pointer; display: block; margin: 20px auto; }
    canvas { display: block; margin: 30px auto; max-width: 100%; }
    .description-block { background: #f0f4f9; border-left: 5px solid #4d9de0; padding: 15px; margin-bottom: 20px; }
    .form-section { text-align: center; margin-top: 20px; }
    .form-section input { padding: 10px; margin: 5px; width: 70%; max-width: 300px; display: block; margin-left: auto; margin-right: auto; }
    .next-steps-box { background: #e5f8e8; border-left: 6px solid #4CAF50; padding: 15px; margin-top: 30px; }
    #introPage { text-align: center; margin-top: 50px; }
    #introLogo, #resultsLogo { max-width: 220px; display: block; margin: 0 auto 20px auto; }
    #successMessage { text-align: center; color: green; font-weight: bold; display: none; }
  </style>
</head>
<body>

  <!-- ✅ Intro Page -->
  <div id="introPage">
    <img src="logo.png" id="introLogo" alt="Logo" />
    <h1>Are You Ready to Discover Your Top Needs for Connection?</h1>
    <p>You're only 24 questions away from learning how you were created for connection...</p>
    <button id="startQuiz">Start Quiz</button>
  </div>

  <!-- ✅ Quiz Section -->
  <div id="quizSection" style="display:none;">
    <h1>What Are Your Top Intimacy Needs?</h1>
    <div class="progress" id="progressText">Question 1 of 24</div>

    <form id="quizForm">
      <div id="quiz"></div>
      <button type="button" id="nextButton">Next</button>
    </form>
  </div>

  <!-- ✅ Results Section -->
  <div id="resultSection" style="display:none; text-align:center;">
    <img src="logo.png" id="resultsLogo" alt="Logo" />
    <h2>Your Personalized Intimacy Profile</h2>
    <canvas id="chart"></canvas>
    <div id="descriptions"></div>

    <div class="form-section" id="emailSection">
      <input type="text" id="nameInput" placeholder="Your Name" required />
      <input type="email" id="emailInput" placeholder="Your Email" required />
      <button id="sendButton" disabled>Send & Download My Results</button>
    </div>

    <p id="successMessage">✅ Your results have been sent, and your PDF has been downloaded!</p>

    <div class="next-steps-box">
      <strong>What To Do Next:</strong><br/>
      Share your top 4 intimacy needs with your spouse. Choose one small, practical action this week to grow in each area. 
      Consider praying together, discussing what each need looks like, or planning a date that nurtures one of your top areas.
    </div>
  </div>

<script>
/* ✅ Questions & Descriptions */
const questions = [
  { q: "I feel most connected when we share spiritual beliefs or pray together.", type: "Spiritual" },
  { q: "I value deep emotional conversations where I feel fully heard and understood.", type: "Emotional" },
  { q: "Having respectful, honest communication—especially during conflict—is important to me.", type: "Conflict" },
  { q: "I enjoy growing intellectually together—learning, reading, or discussing ideas.", type: "Intellectual" },
  { q: "Being physically close (hugs, cuddles, kisses) helps me feel secure.", type: "Physical" },
  { q: "I feel loved when we share sexual closeness and intimacy.", type: "Sexual" },
  { q: "Having shared responsibilities and making decisions as a team matters to me.", type: "Partnership" },
  { q: "I feel safe and connected when we handle tough situations together, not apart.", type: "Conflict" },
  { q: "Spending quality, lighthearted time (laughing, relaxing, having fun) strengthens us.", type: "Affable" },
  { q: "Creating art, music, or other creative experiences together brings me joy.", type: "Creative" },
  { q: "When we manage money together responsibly and transparently, I feel connected.", type: "Financial" },
  { q: "Affectionate touch and presence (like holding hands or snuggling) is very meaningful.", type: "Physical" },
  { q: "I appreciate kind and thoughtful actions done without being asked.", type: "Affable" },
  { q: "Deep heart talks and mutual emotional vulnerability create strong closeness for me.", type: "Emotional" },
  { q: "I feel secure when we set goals together and make decisions as partners.", type: "Partnership" },
  { q: "Shared faith and a common spiritual direction unites us.", type: "Spiritual" },
  { q: "I need to feel sexually desired and enjoyed by my partner.", type: "Sexual" },
  { q: "Playful time, laughing, or even watching a show together helps me connect.", type: "Affable" },
  { q: "It’s important to me that we can talk respectfully even during arguments.", type: "Conflict" },
  { q: "Using money wisely and discussing purchases builds trust and closeness.", type: "Financial" },
  { q: "Collaborating on creative things or solving problems creatively makes me feel alive.", type: "Creative" },
  { q: "I love when we pray together, read Scripture, or serve with shared faith.", type: "Spiritual" },
  { q: "We grow closer when we talk about values, dreams, and big ideas.", type: "Intellectual" },
  { q: "Being emotionally safe and not judged lets me open my heart.", type: "Emotional" }
];

const intimacyDescriptions = {
  Spiritual: "Shared faith and values form the foundation of your bond.",
  Emotional: "You long to feel emotionally safe and deeply known.",
  Intellectual: "You enjoy connecting through thoughtful conversations.",
  Physical: "Being close through touch helps you feel safe and loved.",
  Sexual: "Sexual intimacy expresses affection, passion, and closeness.",
  Conflict: "You value staying connected even during disagreements.",
  Partnership: "You thrive when responsibilities and decisions are shared.",
  Affable: "Playfulness, kindness, and joy build your connection.",
  Creative: "Creative activities and imagination inspire closeness.",
  Financial: "Transparency with money strengthens trust and unity.",
  Commitment: "Loyalty and security form a foundation for your love.",
  Recreational: "Fun, leisure, and shared activities grow connection."
};

const typeColors = {
  Spiritual:"#FF4D4D", Emotional:"#4D9DE0", Intellectual:"#1A3C5E",
  Physical:"#FDC57B", Sexual:"#92C9D6", Conflict:"#F67599",
  Partnership:"#D07E5F", Affable:"#A1B56C", Creative:"#C084FC",
  Financial:"#7BC1D1", Commitment:"#BAA0F5", Recreational:"#FFE07B"
};

const scores = {};
Object.keys(intimacyDescriptions).forEach(t=>scores[t]=0);

let currentQuestion=0;

/* ✅ Intro Page Logic */
document.getElementById("startQuiz").addEventListener("click", () => {
  document.getElementById("introPage").style.display = "none";
  document.getElementById("quizSection").style.display = "block";
  showQuestion(currentQuestion);
});

function showQuestion(i){
  const quizContainer=document.getElementById("quiz");
  const progressText=document.getElementById("progressText");
  quizContainer.innerHTML='';
  const q=questions[i];
  const div=document.createElement("div");
  div.className="question active";
  div.innerHTML=`<h3>${q.q}</h3>
  <label><input type="radio" name="q${i}" value="5"> Strongly Agree</label>
  <label><input type="radio" name="q${i}" value="4"> Agree</label>
  <label><input type="radio" name="q${i}" value="3"> Neutral</label>
  <label><input type="radio" name="q${i}" value="2"> Disagree</label>
  <label><input type="radio" name="q${i}" value="1"> Strongly Disagree</label>`;
  quizContainer.appendChild(div);
  progressText.textContent=`Question ${i+1} of ${questions.length}`;
}

document.getElementById("nextButton").addEventListener("click",()=>{
  const selected=document.querySelector(`input[name="q${currentQuestion}"]:checked`);
  if(!selected){alert("Please select an answer.");return;}
  scores[questions[currentQuestion].type]+=parseInt(selected.value);
  currentQuestion++;
  if(currentQuestion<questions.length){showQuestion(currentQuestion);}
  else{
    document.getElementById("quizSection").style.display="none";
    document.getElementById("resultSection").style.display="block";
    displayResults();
  }
});

function displayResults() {
  const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
  const priority = sorted.slice(0, 4);
  const progress = sorted.slice(4, 8);
  const presence = sorted.slice(8, 12);

  // Helper to create each section
  function sectionHTML(title, desc, items) {
    return `
      <div style="margin-top:20px;">
        <h3 style="margin-bottom:5px;">${title}</h3>
        <p style="margin-top:0; margin-bottom:10px; font-size:14px;">${desc}</p>
        ${items
          .map(
            ([t, s]) => `
          <div class="description-block" style="border-left:8px solid ${typeColors[t]}; margin-bottom:10px;">
            <strong>${t}</strong> (Score: ${s})<br/>${intimacyDescriptions[t]}
          </div>
        `
          )
          .join("")}
      </div>
    `;
  }

  // Explanation under the title
  const explanation = `
    <p style="font-size:14px; margin-top:5px;">
      <strong>Explanation of Your Results:</strong> Your Personalized Intimacy Profile is based on the Covenant Intimacy Fulfillment Model™. 
      We believe God designed every marriage to flourish through all 12 types of intimacy. Each type—spiritual, emotional, physical, and more—plays a vital role in creating a marriage that feels safe, close, and deeply fulfilling.
      <br><br>
      Your results are divided into three parts. Each part includes four intimacy types that reflect how you naturally prioritize connection:
    </p>
  `;

  // Custom headings + descriptions
  const priorityTitle = "Priority – Your Highest Intimacy Needs";
  const priorityDesc = "These are the four areas that matter most to you. When these needs are met, you feel deeply connected and loved.";

  const progressTitle = "Progress – Areas for Growth";
  const progressDesc = "These are the next four areas that are meaningful but may not feel as urgent as your top priorities. Focusing here helps bring balance and depth to your marriage.";

  const presenceTitle = "Presence – Often Overlooked, Still Essential";
  const presenceDesc = "These are the last four areas, which scored lowest for you. While they may not feel as important, nurturing them is key to experiencing the full closeness and unity God designed for marriage.";

  const finalReminder = `
    <p style="margin-top:15px; font-size:14px;">
      <strong>Remember:</strong> A thriving marriage isn’t just about meeting your top needs. 
      It’s about valuing and growing in all 12 types of intimacy, because each one reflects a part of God’s beautiful design for oneness in marriage.
    </p>
  `;

  document.getElementById("descriptions").innerHTML =
    explanation +
    sectionHTML(priorityTitle, priorityDesc, priority) +
    sectionHTML(progressTitle, progressDesc, progress) +
    sectionHTML(presenceTitle, presenceDesc, presence) +
    finalReminder;

  renderChart(sorted);
}

/* ✅ Updated PDF Generator with cover page, new text, page numbers, and smaller footer */


async function generatePDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "pt", "a4");

  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const marginX = 30;
  const marginY = 40;
  const usableWidth = pageWidth - marginX * 2;

  let yPos = marginY;

  function addPageNumber(pageNum) {
    pdf.setFontSize(10);
    pdf.setTextColor("#555555");
    pdf.text(`Page ${pageNum}`, pageWidth - 60, pageHeight - 20);
  }

  function addSectionImage(imgData, imgProps) {
    const imgHeight = (imgProps.height * usableWidth) / imgProps.width;
    if (yPos + imgHeight > pageHeight - 60) {
      addPageNumber(pdf.internal.getNumberOfPages());
      pdf.addPage();
      yPos = marginY;
    }
    pdf.addImage(imgData, "PNG", marginX, yPos, usableWidth, imgHeight);
    yPos += imgHeight + 15;
  }

  // Clone results without email form
  const resultClone = document.getElementById("resultSection").cloneNode(true);
  const emailForm = resultClone.querySelector("#emailSection");
  if (emailForm) emailForm.remove();

  const chartCanvas = document.getElementById("chart");
  const chartImage = chartCanvas.toDataURL("image/png");
  const clonedChart = resultClone.querySelector("#chart");
  const chartImg = document.createElement("img");
  chartImg.src = chartImage;
  chartImg.style.width = "90%";
  clonedChart.replaceWith(chartImg);

  const title = resultClone.querySelector("h2");
  const chart = chartImg;
  const sections = resultClone.querySelectorAll("h3");

  const pieces = [];

  // Title + Logo + Explanation
  const titleBlock = document.createElement("div");
  titleBlock.appendChild(resultClone.querySelector("#resultsLogo").cloneNode(true));
  titleBlock.appendChild(title.cloneNode(true));

  const explanationText = document.createElement("p");
  explanationText.style.fontSize = "14px";
  explanationText.innerHTML = `
    <strong>Explanation of Your Results:</strong> Your Personalized Intimacy Profile is based on the Covenant Intimacy Fulfillment Model™. 
    We believe God designed every marriage to flourish through all 12 types of intimacy. Each type—spiritual, emotional, physical, and more—plays a vital role in creating a marriage that feels safe, close, and deeply fulfilling.<br><br>
    Your results are divided into three parts. Each part includes four intimacy types that reflect how you naturally prioritize connection:
  `;
  titleBlock.appendChild(explanationText);
  pieces.push(titleBlock);

  const chartBlock = document.createElement("div");
  chartBlock.style.textAlign = "center";
  chartBlock.appendChild(chart.cloneNode(true));
  pieces.push(chartBlock);

  // Sections renamed dynamically
  sections.forEach((section) => {
    let sectionColor = "#4D9DE0"; // default blue
    if (section.textContent.includes("Top 4")) {
      section.textContent = "Priority – Your Highest Intimacy Needs";
      sectionColor = "#FF4D4D"; // red
    } else if (section.textContent.includes("Moderate 4")) {
      section.textContent = "Progress – Areas for Growth";
      sectionColor = "#4D9DE0"; // brand blue
    } else if (section.textContent.includes("Maintenance 4")) {
      section.textContent = "Presence – Often Overlooked, Still Essential";
      sectionColor = "#A1B56C"; // green
    }

    const block = document.createElement("div");
    block.dataset.headerColor = sectionColor; // store color for later use
    block.appendChild(section.cloneNode(true));

    let sibling = section.nextElementSibling;
    while (sibling && sibling.tagName !== "H3") {
      block.appendChild(sibling.cloneNode(true));
      sibling = sibling.nextElementSibling;
    }

    if (section.textContent.includes("Presence")) {
      const reminder = document.createElement("p");
      reminder.style.fontSize = "14px";
      reminder.innerHTML =
        "<strong>Remember:</strong> A thriving marriage isn’t just about meeting your top needs. It’s about valuing and growing in all 12 types of intimacy, because each one reflects a part of God’s beautiful design for oneness in marriage.";
      block.appendChild(reminder);
    }

    pieces.push(block);
  });

  // 📄 Cover Page
  const centerX = pageWidth / 2;
  const logo = new Image();
  logo.src = "logo.png";
  await new Promise((res) => (logo.onload = res));

  pdf.addImage(logo, "PNG", centerX - 80, 80, 160, 80);

  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(28);
  pdf.setTextColor("#1A3C5E");
  pdf.text("Your Personalized Intimacy Profile", centerX, 200, { align: "center" });

  pdf.setFontSize(15);
  pdf.setFont("helvetica", "normal");
  pdf.text("Based on the Covenant Intimacy Fulfillment Model™", centerX, 230, { align: "center" });

  const userName = document.getElementById("nameInput").value || "Valued User";
  const today = new Date().toLocaleDateString(undefined, { month: "long", day: "numeric", year: "numeric" });
  pdf.setFontSize(12);
  pdf.text(`Prepared for ${userName} – ${today}`, centerX, 260, { align: "center" });

  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(14);
  pdf.text("Discover Your Path to Deeper Connection", centerX, 310, { align: "center", maxWidth: pageWidth - 80 });

  pdf.setFont("helvetica", "normal");
  pdf.setFontSize(12);
  pdf.text(
    "This profile reveals how you uniquely prioritize the 12 types of intimacy God designed for marriage. See your Priority, Progress, and Presence areas—and learn how each one can bring you and your spouse closer than ever.",
    centerX,
    340,
    { align: "center", maxWidth: pageWidth - 80 }
  );

  pdf.setFont("helvetica", "italic");
  pdf.text(
    "This profile is based on the Covenant Intimacy Fulfillment Model™ (CIFM), developed through the research of Dr. Scott Inman, PhD—founder of the Happy Marriage, Happy Life™ marriage curriculum and resources.",
    centerX,
    410,
    { align: "center", maxWidth: pageWidth - 80 }
  );

  pdf.setFontSize(10);
  pdf.setTextColor("#666666");
  pdf.text("© 2025 HappyMarriageHappyLife.com – All Rights Reserved", centerX, pageHeight - 40, { align: "center" });

  pdf.addPage();

  // Render each piece
  yPos = marginY;
  for (let piece of pieces) {
    const tempDiv = document.createElement("div");
    tempDiv.style.width = "700px";
    tempDiv.appendChild(piece);
    document.body.appendChild(tempDiv);

    const canvas = await html2canvas(tempDiv, { scale: 2, useCORS: true });
    document.body.removeChild(tempDiv);

    const imgData = canvas.toDataURL("image/png");
    const imgProps = pdf.getImageProperties(imgData);

    // Draw colored header bar before adding section
    const color = piece.dataset.headerColor;
    if (color) {
      if (yPos + 50 > pageHeight - 60) {
        addPageNumber(pdf.internal.getNumberOfPages());
        pdf.addPage();
        yPos = marginY;
      }
      pdf.setFillColor(color);
      pdf.rect(marginX, yPos, usableWidth, 25, "F");
      pdf.setTextColor("#FFFFFF");
      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(14);
      const headerTitle = piece.querySelector("h3")?.textContent || "";
      pdf.text(headerTitle, marginX + 10, yPos + 17);
      yPos += 40; // add spacing after header
    }

    addSectionImage(imgData, imgProps);
  }

  addPageNumber(pdf.internal.getNumberOfPages());

  // Footer with margins
  const footerHeight = 40;
  const footerY = pageHeight - footerHeight;
  pdf.setFillColor("#4D9DE0");
  pdf.rect(marginX, footerY, pageWidth - marginX * 2, footerHeight, "F");

  pdf.setTextColor("#FFFFFF");
  pdf.setFont("helvetica", "bold");
  pdf.setFontSize(12);
  pdf.text(
    "HappyMarriageHappyLife.com  |  Covenant Intimacy Fulfillment Model™ – Helping Couples Build Lasting Love",
    pageWidth / 2,
    footerY + 25,
    { align: "center" }
  );

  pdf.save("Intimacy-Results.pdf");
}


</script>
</body>
</html>
