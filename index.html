<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Marriage Connection Assessment — Individual</title>

<!-- ===========================================================
     PATCH NOTES (v13+patch):
     - Results page rebuilt with DOM construction (original v13)
     - Teaching copy integrated for:
       * Compassion & Care (APS temperament, expressed & wanted)
       * Respect & Recognition (Strong/Moderate/Needs Attention)
       * Connection Patterns (Steady/Reassurance/Independent/Guarded)
     - Restored full "Connection Patterns" section in results
     - Added Communication conditional copy + dropdown helper
     - Safe overrides (no need to remove original helpers)
     =========================================================== -->

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&family=Open+Sans:wght@600;700&family=Merriweather:ital,wght@1,400;1,700&family=Great+Vibes&display=swap" rel="stylesheet">

<style>
  /* Base layout */
  body { font-family: Arial, sans-serif; background:#FFF9F2; color:#1A3C5E; max-width: 980px; margin:auto; padding:20px; box-sizing:border-box; }
  h1,h2,h3,h4{ text-align:center; line-height:1.25; }
  .card { background:#fff; border:2px solid #4D9DE0; border-radius:12px; padding:24px; box-shadow:0 8px 25px rgba(0,0,0,.08); margin: 20px auto; }
  .btn, .answer-btn { background:#4D9DE0; color:#fff; font-weight:700; border:none; border-radius:8px; padding:12px 16px; cursor:pointer; margin:10px auto; display:block; width:100%; max-width:520px; }
  .btn:hover, .answer-btn:hover { background:#3A7FBF; }
  .hidden{ display:none; }
  .muted{ color:#9aa3ab; text-align:center; margin-top:12px; font-size:12px; }

  /* Progress */
  .progress-bar-container{ width:100%; max-width:520px; height:10px; background:#E0E0E0; border-radius:5px; margin:8px auto 4px; }
  .progress-bar{ height:100%; background:#FF4D4D; border-radius:5px; transition:width .25s; }

  /* Results visuals */
  .result-block { margin-bottom:16px; page-break-inside:avoid; padding:16px; border-left:8px solid #4D9DE0; border-radius:8px; background:#fff; line-height:1.3; }
  .section-title { color:#1A3C5E; font-family:'Open Sans',sans-serif; font-weight:700; font-size:16pt; margin-bottom:10px; }
  .subsection-title { color:#1A3C5E; font-family:'Roboto',sans-serif; font-weight:600; font-size:14pt; margin: 15px 0 8px; text-align:center; }
  .section-divider{ height:1pt; background-color:#FF4D4D; width:100%; max-width:860px; margin:24pt auto; }
  .subsection-divider{ height:1pt; background-color:rgba(77,157,224,.5); width:100%; max-width:860px; margin:14pt auto; }
  .verse{ font-family:'Merriweather', serif; font-style:italic; color:#FF4D4D; text-align:center; margin:4px auto 10px; max-width:820px; }
  .thank-title{ margin-top:0; margin-bottom:12pt; font-family:'Great Vibes',cursive; color:#4D9DE0; font-size:3.6rem; line-height:1.1; text-align:center; }

  /* Picker cards */
  .mini-grid { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
  .mini-card { border:1.5px solid #4D9DE0; border-radius:8px; background:#fff; padding:10px 12px; max-width:360px; flex:1 1 280px; cursor:pointer; transition: box-shadow .15s, border-color .15s, background .15s; }
  .mini-card.selected { background: rgba(77,157,224,0.08); border-color:#3A7FBF; box-shadow: 0 0 0 2px rgba(58,127,191,0.20) inset; }
  .mini-title { font-weight:700; margin:0 0 6px 0; }
  .mini-desc  { font-size:.95rem; color:#4a607a; line-height:1.3; margin:0; }

  .pill { display:inline-block; padding:8px 12px; border-radius:999px; border:1px solid #d0d7de; margin:6px; cursor:pointer; }
  .pill.selected{ background:#3A7FBF; border-color:#3A7FBF; color:#fff; }

  /* Print */
  @media print { .btn { display:none !important; } .card { border:none; box-shadow:none; } body { background:#fff; } }
</style>
</head>
<body>

<!-- =======================
     Section 3: Intro Page
     ======================= -->
<div id="introPage" class="card">
  <h1>Your Guide to a Deeper Connection</h1>
  <div class="intro-text">
    <p style="text-align:center;"><em>Ready for a few “aha!” moments?</em></p>
    <p>This is a moment to reflect on what builds intimacy and how you navigate daily life.</p>
    <p>When you’re done, you’ll see a personalized profile with practical ideas you can put to work right away.</p>
    <p style="margin-bottom:0.2em;"><strong>How it works:</strong></p>
    <div class="lh-13" style="margin-top:0;">
      <p style="margin:0;">Enter your name and tap Start. Answer each prompt honestly—there are no “right” answers.</p>
    </div>
  </div>
  <div class="row" style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:12px;">
    <input id="yourName" class="input" placeholder="Your name" aria-label="Your name" style="border:1px solid #4D9DE0; border-radius:8px; padding:10px 12px; min-width:260px; text-align:center;">
  </div>
  <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:10px;">
    <button id="startFreshBtn" class="btn" style="max-width:240px;">Start Assessment</button>
    <button id="resumeBtn" class="btn hidden" style="max-width:240px; background:#6A4C93;">Resume Saved Progress</button>
  </div>
  <p class="muted">Build: <span id="buildBadgeIntro"></span></p>
</div>

<!-- =======================
     Section 4: Quiz Page
     ======================= -->
<div id="quizPage" class="card hidden">
  <h2 id="quizTitle">Assessment</h2>
  <div class="progress-bar-container"><div class="progress-bar" id="progressBar"></div></div>
  <div id="progress" style="text-align:center; margin-bottom:8px;"></div>
  <div id="questionContainer" class="question-box"></div>
</div>

<!-- =======================
     Section 5: Results Page
     ======================= -->
<div id="resultPage" class="card hidden">
  <h2 id="resultsHeader">Your Marriage Connection Profile</h2>
  <div id="resultsIntro" class="intro-text">
    <p>Welcome to the Marriage Connection Assessment, a guided experience designed to help you build a covenant, joy-filled marriage as God designed.</p>
    <p>This is your personalized guide to understanding connection in a new way. Think of this not as a set of labels, but as a living map to the unique landscape of your relationship—it helps you name what’s true today and aim for what’s possible tomorrow.</p>
  </div>
  <div id="results"></div>
  <p class="muted">Build: <span id="buildBadgeResults"></span></p>
</div>

<script>
/* =======================================
   Section 6: Build/Version Marker
   ======================================= */
const BUILD = "individual-v13+patch";
document.addEventListener('DOMContentLoaded', () => {
  const a = document.getElementById('buildBadgeIntro'); if(a) a.textContent = BUILD;
  const b = document.getElementById('buildBadgeResults'); if(b) b.textContent = BUILD;
  if (localStorage.getItem('mca_individual_state_v1')) {
    document.getElementById('resumeBtn').classList.remove('hidden');
  }
});

/* =======================================
   Section 7: Core Data & Palettes
   ======================================= */
const INTIMACY = {
  Spiritual:{label:"Spiritual Intimacy", desc:"Spiritual intimacy is the shared sense of purpose and connection to God’s design that anchors a relationship. It’s the core that shapes how love is experienced and expressed, guiding your journey together."},
  Emotional:{label:"Emotional Intimacy", desc:"Emotional intimacy is the key to deep connection, creating a safe space for vulnerability and empathy. This crucial bond is the gateway that allows all other forms of closeness to flourish."},
  Commitment:{label:"Commitment Intimacy", desc:"Commitment intimacy is the security and dedication that acts as the core of a relationship, providing the stability needed to weather life’s storms. This dedicated bond is what allows a couple to face challenges and deepen their connection over time."},
  Intellectual:{label:"Intellectual Intimacy", desc:"Intellectual intimacy is about sharing a mental and emotional connection through engaging conversations and mutual respect for each other’s thoughts and values. It builds a powerful bond forged by the exchange of ideas and the exploration of new perspectives."},
  Affable:{label:"Affable Intimacy", desc:"Affable intimacy is the ease and comfort found in a relationship, creating a peaceful and enjoyable environment. It’s the simple joy of being agreeable and easygoing in your daily interactions with each other."},
  Conflict:{label:"Conflict Intimacy", desc:"Conflict intimacy is the ability to maintain a strong connection and mutual respect even during disagreements. It allows couples to navigate differences and grow closer through the process of resolving conflicts together."},
  Recreational:{label:"Recreational Intimacy", desc:"Recreational intimacy is about sharing laughter, playfulness, and joy through shared hobbies and experiences. It brings vitality and fun to a relationship, creating cherished memories that strengthen the bond."},
  Partnership:{label:"Partnership Intimacy", desc:"Partnership intimacy is the collaborative connection built by working together to manage daily responsibilities and make decisions. This forges a powerful bond as a couple functions as a unified team, tackling life’s challenges side by side."},
  Stability:{label:"Stability Intimacy", desc:"Stability intimacy is about transparently and honestly managing resources like time and money together, building a foundation of trust and a secure future. It’s a shared commitment to aligning your values as you work toward a common goal."},
  Creative:{label:"Creative Intimacy", desc:"Creative intimacy is the shared joy of bringing new ideas to life by building and dreaming together. This bond is strengthened through the process of collaborating on projects and seeing your shared vision become a reality."},
  Physical:{label:"Physical Intimacy", desc:"Physical intimacy involves connecting through non-sexual touch, comfort, and physical presence. This kind of closeness creates a sense of safety and security, affirming your bond through simple gestures and shared moments."},
  Sexual:{label:"Sexual Intimacy", desc:"Sexual intimacy is a passionate, exclusive, and sacred physical union that expresses a deep, committed connection. It’s a unique and powerful way to honor your bond through a shared experience of vulnerability and pleasure."}
};
const TYPES = Object.keys(INTIMACY);

const typeColors = {
  Spiritual:"#6A4C93", Emotional:"#FF7A70", Commitment:"#FFB347",
  Intellectual:"#4C6B9B", Affable:"#FFB6C1", Recreational:"#4DD2FF",
  Partnership:"#3CB371", Stability:"#FFD700", Creative:"#FF66CC",
  Conflict:"#FFA552", Physical:"#FF8C69", Sexual:"#E63946"
};
const typeOpac = {
  Spiritual:"rgba(106,76,147,.08)", Emotional:"rgba(255,122,112,.08)", Commitment:"rgba(255,179,71,.08)",
  Intellectual:"rgba(76,107,155,.08)", Affable:"rgba(255,182,193,.08)", Recreational:"rgba(77,210,255,.08)",
  Partnership:"rgba(60,179,113,.08)", Stability:"rgba(255,215,0,.08)", Creative:"rgba(255,102,204,.08)",
  Conflict:"rgba(255,165,82,.08)", Physical:"rgba(255,140,105,.08)", Sexual:"rgba(230,57,70,.08)"
};

/* =======================================
   Section 8: Local Storage & State
   ======================================= */
const STORAGE_KEY = "mca_individual_state_v1";
let yourName = "";
const TOTAL_STEPS = 13; // 0..12
let step = 0;

const DEFAULT_ANSWERS = {
  rank: [...TYPES],
  expressedTop2: [],
  desiredTop2: [],
  social: {},
  decision: {},
  rr: { rr1:null, rr2:null },
  bond: {},
  top4: [],
  next4: []
};
let answers = JSON.parse(JSON.stringify(DEFAULT_ANSWERS));

function ensureDefaults(){
  if (!answers || typeof answers !== 'object') answers = JSON.parse(JSON.stringify(DEFAULT_ANSWERS));
  if (!Array.isArray(answers.rank)  || answers.rank.some(k=>!INTIMACY[k])) answers.rank = [...TYPES];
  if (!Array.isArray(answers.expressedTop2)) answers.expressedTop2 = [];
  if (!Array.isArray(answers.desiredTop2))   answers.desiredTop2   = [];
  if (!answers.social || typeof answers.social !== 'object') answers.social = {};
  if (!answers.decision || typeof answers.decision !== 'object') answers.decision = {};
  if (!answers.rr || typeof answers.rr !== 'object') answers.rr = { rr1:null, rr2:null };
  if (!answers.bond || typeof answers.bond !== 'object') answers.bond = {};
  if (!Array.isArray(answers.top4))  answers.top4  = [];
  if (!Array.isArray(answers.next4)) answers.next4 = [];
  if (!Number.isInteger(step) || step < 0 || step >= TOTAL_STEPS) step = 0;
}
function saveState(){
  ensureDefaults();
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify({ yourName, step, answers })); } catch(e){}
}
function loadState(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return false;
    const s = JSON.parse(raw);
    if(s && typeof s === 'object'){
      yourName = s.yourName || yourName;
      step = Number.isInteger(s.step) ? s.step : step;
      answers = s.answers || answers;
      ensureDefaults();
      return true;
    }
    return false;
  } catch(e){ return false; }
}
function clearState(){ try { localStorage.removeItem(STORAGE_KEY); } catch(e){} }

/* =======================================
   Section 9: Scripture & Copy (original)
   ======================================= */
const scripture = {
  compassionCare: "“Be completely humble and gentle; be patient, bearing with one another in love.” — Ephesians 4:2",
  socialEngagement: "“Therefore encourage one another and build each other up.” — 1 Thessalonians 5:11",
  decisionLeadership: "“If any of you lacks wisdom, you should ask God … and it will be given to you.” — James 1:5",
  respectRecognition: "“Honor one another above yourselves.” — Romans 12:10",
  connectionPattern: "“Make every effort to keep the unity of the Spirit through the bond of peace.” — Ephesians 4:3",
  conflictStrategies: "“Everyone should be quick to listen, slow to speak and slow to become angry.” — James 1:19",
  thankYou: "“May the Lord make your love increase and overflow for each other and for everyone else, just as ours does for you.” — 1 Thessalonians 3:12"
};
const affEXP = {
  Playful: "You naturally lift the mood with humor, lightness, and spontaneous moments that say, “I’m with you.” You turn ordinary spaces into warm, safe places.",
  Initiative: "You show love by stepping in and taking pressure off—solving problems, removing obstacles, and protecting what matters.",
  DeepTalk: "You invite depth—lingering in meaningful conversation, asking curious questions, and making others feel profoundly understood.",
  Warmth: "You offer steady presence and gentle affection. Your calming tone, touch, and attention help your spouse exhale and feel safe.",
  Support: "You love through action: pitching in, following through, and sharing the load. Your reliability says, “You’re not alone—I'm with you.”"
};
const affDES = {
  Playful: "You feel loved when your spouse keeps things light, playful, and hope-filled—like a breath of fresh air when life feels heavy.",
  Initiative: "You feel most cared for when your spouse takes initiative—removing stress, solving a problem, or leading with strength and protection.",
  DeepTalk: "You feel cherished when your spouse slows down, listens deeply, and engages your thoughts and heart with focused, meaningful time.",
  Warmth: "You feel secure with gentle presence, unhurried attention, and comforting touch that says, “I’m here, and you matter.”",
  Support: "You feel honored when your spouse helps practically—sharing responsibilities and showing up consistently in the daily things."
};
const temperamentDetails = {
  E: { looks:"You energize the room and move things forward with enthusiasm.", watch:"Fast pace can out-run deeper needs or quieter voices.", tip:"Schedule both lively connection and quiet check-ins to stay balanced." },
  S: { looks:"You provide direction, set goals, and protect progress.", watch:"Decisiveness can feel controlling if not co-authored.", tip:"Invite input early and name where you’re flexible." },
  R: { looks:"You think deeply, ask great questions, and value thoughtfulness.", watch:"Over-analysis can delay decisions or feel distant.", tip:"Time-box decisions and surface feelings—not just facts." },
  A: { looks:"You bring calm, keep the peace, and reduce friction.", watch:"Avoiding tension can postpone needed clarity.", tip:"Name one concrete next step even when keeping it gentle." },
  U: { looks:"You serve steadily, include others, and build trust.", watch:"Understating your needs can lead to quiet resentment.", tip:"Voice one specific need and one boundary you appreciate." }
};
const patternDetail = {
  SteadyConnector: {
    connectionType: "Harmony-focused and steady—your presence calms the room and keeps connection safe.",
    strengths: "create a peaceful space where hard conversations feel possible. You’re consistent, fair, and great at lowering tension.",
    challenges: "can move past issues too quickly or downplay your own needs to keep the peace, which can leave things unresolved.",
    tendencies: "In conflict, you often smooth things over fast and avoid going deep, hoping the calm will hold.",
    coping: "Try a 5–10 minute daily check-in. Name one feeling and one specific need before you move to solutions."
  },
  ReassuranceSeeker: {
    connectionType: "Attachment-aware and passionate—you lead with heart and crave clarity when things feel off.",
    strengths: "fight for closeness and speak up when something feels wrong. You’re empathetic and quick to repair.",
    challenges: "needing reassurance now can feel intense and escalate emotions if it doesn’t arrive quickly.",
    tendencies: "In conflict, you pursue answers and closeness immediately, which can feel like pressure to a withdrawing partner.",
    coping: "Ask for one clear reassurance, breathe together, then agree to a short reset with a promised return time."
  },
  IndependentConnector: {
    connectionType: "Thoughtful and composed—you value clarity and reflection to keep connection honest and stable.",
    strengths: "think before you speak, de-escalate well, and protect against saying things you don’t mean.",
    challenges: "taking space without clarity can feel like distance or shutdown to your spouse.",
    tendencies: "In conflict, you step back to think. Without a return time, that pause can be heard as disconnection.",
    coping: "Request space with a specific return time (e.g., 30 minutes). Offer one sentence of reassurance first."
  },
  GuardedConnector: {
    connectionType: "Careful and loyal—you open slowly and build trust through consistency.",
    strengths: "are dependable and don’t overreact. When you commit, you show up.",
    challenges: "caution can look like walls. It’s easy to assume negative intent and protect rather than share.",
    tendencies: "In conflict, you may go quiet, assume the worst, or agree just to end it—then carry the weight alone.",
    coping: "Use micro-trust steps: keep one small promise daily, write a short note before hard talks, and name one safe topic to open."
  }
};

/* =======================================
   Section 10: Launch / Start Handler
   ======================================= */
document.getElementById('startFreshBtn').onclick = () => {
  try {
    clearState();
    const typed = (document.getElementById('yourName')?.value || "").trim();
    yourName = typed || "You";
    step = 0;
    answers = JSON.parse(JSON.stringify(DEFAULT_ANSWERS));
    saveState();
    showQuiz();
  } catch (e) {
    alert("Oops — please reload the page.");
  }
};
document.getElementById('resumeBtn').onclick = () => {
  try {
    const restored = loadState();
    const typed = (document.getElementById('yourName')?.value || "").trim();
    if (typed) yourName = typed;
    ensureDefaults();
    if (!restored) step = 0;
    showQuiz();
  } catch (e) {
    alert("Couldn’t resume. Starting fresh.");
    clearState(); step = 0; answers = JSON.parse(JSON.stringify(DEFAULT_ANSWERS)); showQuiz();
  }
};
function showQuiz(){ hideAllPages(); document.getElementById('quizPage').classList.remove('hidden'); document.getElementById('quizTitle').textContent = `Assessment — ${yourName}`; renderStep(); }
function hideAllPages(){ document.getElementById('introPage').classList.add('hidden'); document.getElementById('quizPage').classList.add('hidden'); document.getElementById('resultPage').classList.add('hidden'); }

/* =======================================
   Section 11: Step Renderer (auto-advance)
   ======================================= */
function renderStep(){
  ensureDefaults();
  const progEl = document.getElementById('progress'); const barEl  = document.getElementById('progressBar');
  if (progEl) progEl.textContent = `Step ${step+1} of ${TOTAL_STEPS}`;
  if (barEl)  barEl.style.width   = `${((step+1)/TOTAL_STEPS)*100}%`;

  const box = document.getElementById('questionContainer'); box.innerHTML = "";

  if(step===0){ renderTopNextPicker(box); saveState(); return; }

  if(step===1) return renderPick2(box, "How you give love — choose your Top 2", "expressedTop2");
  if(step===2) return renderPick2(box, "How you feel most loved — choose your Top 2", "desiredTop2");

  if(step===3) return renderSingleList(box, "In groups, I usually…", [
    ["E","Bring energy and get people talking."],
    ["S","Organize or give structure to the time."],
    ["R","Connect deeply with one or two people."],
    ["A","Keep it light, calm, and agreeable."],
    ["U","Make sure everyone feels included."]
  ], val => { answers.social["social1"]=val; saveState(); next(); });

  if(step===4) return renderSingleList(box, "Planning social time, I prefer…", [
    ["E","Lively, people-filled activities."],
    ["S","A clear plan that keeps us on track."],
    ["R","Meaningful, low-key connection."],
    ["A","Relaxed, pressure-free time."],
    ["U","Including others thoughtfully."]
  ], val => { answers.social["social2"]=val; saveState(); next(); });

  if(step===5) return renderSingleList(box, "When a decision is needed, I tend to…", [
    ["E","Choose the fun option and keep momentum."],
    ["S","Decide quickly and set direction."],
    ["R","Analyze details before choosing."],
    ["A","Seek harmony and avoid friction."],
    ["U","Support the plan and contribute steadily."]
  ], val => { answers.decision["decision1"]=val; saveState(); next(); });

  if(step===6) return renderSingleList(box, "On shared projects at home, I usually…", [
    ["E","Keep things upbeat and moving."],
    ["S","Take the lead and drive results."],
    ["R","Plan details and set a thoughtful pace."],
    ["A","Stay flexible and avoid conflict."],
    ["U","Pitch in steadily and support the plan."]
  ], val => { answers.decision["decision2"]=val; saveState(); next(); });

  if(step===7) return renderSingleList(box, "I feel my opinions are respected in our relationship.", [[3,"Strongly Agree"], [2,"Agree"], [1,"Disagree"], [0,"Strongly Disagree"]], val => { answers.rr.rr1 = Number(val); saveState(); next(); });

  if(step===8) return renderSingleList(box, "We are aligned on core values and honor our covenant.", [[3,"Strongly Agree"], [2,"Agree"], [1,"Disagree"], [0,"Strongly Disagree"]], val => { answers.rr.rr2 = Number(val); saveState(); next(); });

  if(step===9) return renderSingleList(box, "During conflict, I naturally…", [
    ["SteadyConnector","Use humor to lower tension."],
    ["ReassuranceSeeker","Push for quick resolution."],
    ["IndependentConnector","Withdraw to think it through."],
    ["IndependentConnector","Stay calm to avoid escalation."],
    ["GuardedConnector","Concede just to end it."]
  ], val => { answers.bond["bond1"]=val; saveState(); next(); });

  if(step===10) return renderSingleList(box, "When I feel unappreciated, I tend to…", [
    ["SteadyConnector","Laugh it off and move on."],
    ["ReassuranceSeeker","Remind my spouse of my effort."],
    ["IndependentConnector","Feel overlooked and pull back."],
    ["IndependentConnector","Let it go to keep peace."],
    ["GuardedConnector","Feel hurt and shut down."]
  ], val => { answers.bond["bond2"]=val; saveState(); next(); });

  if(step===11) return renderSingleList(box, "After a disagreement, I prefer to…", [
    ["ReassuranceSeeker","Repair quickly together."],
    ["IndependentConnector","Pause, then reconnect with a plan."]
  ], val => { answers.bond["bond3"]=val; saveState(); next(); });

  if(step===12) return renderSingleList(box, "When overwhelmed, I prefer to…", [
    ["ReassuranceSeeker","Seek closeness and reassurance now."],
    ["IndependentConnector","Have space first, then return to talk."]
  ], val => { answers.bond["bond4"]=val; saveState(); finalize(); });
}
function next(){ step++; renderStep(); }

/* =========================================================
   Section 12: Step UIs — Top/Next Picker (NEW), Pick-2, Single
   ========================================================= */
function renderTopNextPicker(root){
  ensureDefaults();
  const stage = (answers.top4.length < 4) ? 'top4' : (answers.next4.length < 4) ? 'next4' : 'done';
  if(stage === 'done'){
    const picked = [...answers.top4, ...answers.next4];
    const remaining = TYPES.filter(k => !picked.includes(k));
    answers.rank = picked.length ? [...picked, ...remaining] : [...TYPES];
    saveState(); next(); return;
  }
  const isTop = (stage === 'top4');
  const pickedSet = new Set(isTop ? answers.top4 : answers.next4);
  const alreadyPicked = new Set([...answers.top4, ...answers.next4]);
  const pool = TYPES.filter(k => !alreadyPicked.has(k) || pickedSet.has(k));
  root.innerHTML = `<h3 style="text-align:center;">${isTop?"Pick Your Top 4 Intimacy Types":"Great! Now pick your Next 4"}</h3>
    <p class="rank-help">Tap a card to select (tap again to unselect).</p>
    <p style="text-align:center; margin-top:-6px; color:#4a607a;"><em>Selected: ${pickedSet.size} / 4</em></p>
    <div class="mini-grid" id="miniGrid"></div>`;
  const grid=root.querySelector('#miniGrid');
  pool.forEach(key=>{
    const card=document.createElement('div'); card.className='mini-card'+(pickedSet.has(key)?' selected':''); card.style.borderLeft=`6px solid ${typeColors[key]}`; card.style.paddingLeft='10px';
    card.innerHTML=`<div class="mini-title">${INTIMACY[key].label}</div><p class="mini-desc">${INTIMACY[key].desc}</p>`;
    card.onclick=()=>{ if(pickedSet.has(key)) pickedSet.delete(key); else if(pickedSet.size<4) pickedSet.add(key); if(isTop) answers.top4=[...pickedSet]; else answers.next4=[...pickedSet]; saveState(); (pickedSet.size===4)?setTimeout(()=>renderTopNextPicker(root),120):renderTopNextPicker(root); };
    grid.appendChild(card);
  });
  if(pool.length===0){ const note=document.createElement('p'); note.className='muted'; note.textContent='All picked — advancing…'; root.appendChild(note); setTimeout(()=>{ answers.rank=[...TYPES]; saveState(); next(); },200); }
}

const affectionOptions = [
  {key:"Playful", text:"Playful moments and upbeat encouragement"},
  {key:"Initiative", text:"Taking initiative—removing stressors"},
  {key:"DeepTalk", text:"Deep conversation and focused time"},
  {key:"Warmth", text:"Warm presence and gentle touch"},
  {key:"Support", text:"Practical help and steady teamwork"}
];
function renderPick2(root, title, field){
  ensureDefaults();
  const selected = answers[field] || [];
  root.innerHTML = `<h3 style="text-align:center;">${title}</h3>
    <p class="rank-help">Tap to select two. Your first tap is #1, second is #2. Tap again to unselect.</p>
    <div id="pick2Wrap" style="text-align:center;"></div>
    <p style="text-align:center; margin-top:8px;">Selected: <strong>${selected.length ? selected.map((k,i)=>`${i+1}. ${labelFor(k)}`).join("  ") : "—"}</strong></p>`;
  const wrap = root.querySelector('#pick2Wrap');
  affectionOptions.forEach(o=>{
    const pill = document.createElement('span');
    pill.className = 'pill' + (selected.includes(o.key) ? ' selected' : '');
    pill.textContent = o.text;
    pill.onclick = ()=>{
      const sel = answers[field] || [];
      if(sel.includes(o.key)){ answers[field] = sel.filter(x=>x!==o.key); saveState(); renderStep(); }
      else if(sel.length<2){ answers[field] = [...sel, o.key]; saveState(); if(answers[field].length===2){ next(); } else { renderStep(); } }
    };
    wrap.appendChild(pill);
  });
}
function labelFor(k){ return { Playful:"Playful moments", Initiative:"Taking initiative", DeepTalk:"Deep conversation", Warmth:"Warm presence & touch", Support:"Practical support" }[k] || k; }

function renderSingleList(root, title, options, onPick){
  root.innerHTML = `<h3 style="text-align:center;">${title}</h3>
    <p style="text-align:center; margin-top:-6px; color:#4a607a;"><em>Please answer based on your relationship with your spouse.</em></p>
    <div class="vertical-list"></div>`;
  const v = root.querySelector('.vertical-list');
  options.forEach(([val, txt])=>{
    const b = document.createElement('button'); b.className = 'answer-btn'; b.textContent = txt; b.onclick = ()=> onPick(val); v.appendChild(b);
  });
}

/* =======================================
   Section 13: Finalize & Render Results (original baseline)
   ======================================= */
function finalize(){
  ensureDefaults();
  let core   = Array.isArray(answers.top4)  && answers.top4.length  === 4 ? [...answers.top4]  : [];
  let growth = Array.isArray(answers.next4) && answers.next4.length === 4 ? [...answers.next4] : [];
  if (core.length !== 4 || growth.length !== 4) {
    const r = Array.isArray(answers.rank) && answers.rank.length === TYPES.length ? answers.rank.slice() : TYPES.slice();
    core   = r.slice(0,4); growth = r.slice(4,8);
  }
  const picked = new Set([...core, ...growth]);
  const untapped = TYPES.filter(k => !picked.has(k));

  const sc={E:0,S:0,R:0,A:0,U:0}; Object.values(answers.social).forEach(k=>sc[k]++);
  const dc={E:0,S:0,R:0,A:0,U:0}; Object.values(answers.decision).forEach(k=>dc[k]++);
  const socialTop = Object.entries(sc).sort((a,b)=>b[1]-a[1])[0]?.[0] || null;
  const decisionTop = Object.entries(dc).sort((a,b)=>b[1]-a[1])[0]?.[0] || null;

  const socialSummary=socialTop?({E:"You bring energy and enthusiasm to social settings.",S:"You give structure and help lead groups well.",R:"You prefer deep, thoughtful conversations.",A:"You value calm, low-key connection.",U:"You make sure others feel included and cared for."})[socialTop]:"You adapt flexibly to different situations.";
  const decisionSummary=decisionTop?({E:"You decide with enthusiasm, prioritizing enjoyment and momentum.",S:"You decide decisively, goal-first.",R:"You analyze carefully before choosing.",A:"You seek harmony and consensus.",U:"You steadily support plans and shared goals."})[decisionTop]:"You adapt flexibly to different situations.";

  const rrScore=(answers.rr.rr1??0)+(answers.rr.rr2??0);
  const rrLabel=rrScore>=5?"Strong":rrScore>=3?"Moderate":"Needs Attention";

  const bc={SteadyConnector:0, ReassuranceSeeker:0, IndependentConnector:0, GuardedConnector:0}; Object.values(answers.bond).forEach(k=>bc[k]++);
  const bondingKey=Object.entries(bc).sort((a,b)=>b[1]-a[1])[0]?.[0]||"SteadyConnector";

  renderResults({
    name: yourName||"You",
    coreTypes: core,
    growthTypes: growth,
    untappedTypes: untapped,
    expressedTop2: [...(answers.expressedTop2||[])],
    desiredTop2:   [...(answers.desiredTop2||[])],
    socialTop, decisionTop, socialSummary, decisionSummary,
    rrScore, rrLabel, bondingKey
  });
}

/* =======================================
   Section 14: Result Helpers (original baseline)
   ======================================= */
function typesColumn(name, types){
  const safe = Array.isArray(types) && types.length ? types : TYPES.slice(0,4);
  return `<div class="partner-card"><div class="partner-inner">
      <div class="partner-header">${name || "Results"}</div>
      ${safe.map(k=>`<div class="result-block" style="border-left-color:${typeColors[k]}; background:${typeOpac[k]};">
          <strong>${INTIMACY[k].label}</strong> — ${INTIMACY[k].desc}
        </div>`).join("")}
    </div></div>`;
}
function compassionColumn(p){
  const exp = (p.expressedTop2||[]).map(k=>{
    const acc = temperamentAccentFromAffKey(k);
    return `<div class="result-block" style="border-left-color:${acc.color}; background:${acc.bg};"><strong>Expressed:</strong> ${affEXP[k]}</div>`;
  }).join("");
  const des = (p.desiredTop2||[]).map(k=>{
    const acc = temperamentAccentFromAffKey(k);
    return `<div class="result-block" style="border-left-color:${acc.color}; background:${acc.bg};"><strong>Most Loved:</strong> ${affDES[k]}</div>`;
  }).join("");
  const fallback = `<div class="result-block" style="border-left-color:#4D9DE0;background:rgba(77,157,224,.08);">Make two selections earlier to see personalized details.</div>`;
  return `<div class="partner-card"><div class="partner-inner">
      <div class="partner-header">${p.name || "Results"}</div>
      <div class="partner-subhead"><strong>${p.name || "You"} — You Express Love</strong></div>
      ${exp || fallback}
      <div class="partner-subhead"><strong>${p.name || "You"} — You Feel Most Loved</strong></div>
      ${des || fallback}
    </div></div>`;
}
function buildTemperamentText(topKey, summary){
  if(!topKey) return summary || "You flex based on the moment.";
  const d = temperamentDetails[topKey] || {};
  return `${summary || ""} <br><em>What it looks like:</em> ${d.looks || ""} <br><em>Watch-outs:</em> ${d.watch || ""} <br><em>Helpful tip:</em> ${d.tip || ""}`;
}
function temperamentAccentFromKey(k){
  const map = {
    E: { color: typeColors.Emotional,    bg: typeOpac.Emotional    },
    S: { color: typeColors.Commitment,   bg: typeOpac.Commitment   },
    R: { color: typeColors.Intellectual, bg: typeOpac.Intellectual },
    A: { color: typeColors.Affable,      bg: typeOpac.Affable      },
    U: { color: typeColors.Partnership,  bg: typeOpac.Partnership  }
  };
  return map[k] || { color:"#4D9DE0", bg:"rgba(77,157,224,.08)" };
}
function temperamentAccentFromAffKey(k){ const t = { Playful:"E", Initiative:"S", DeepTalk:"R", Warmth:"A", Support:"U" }[k]; return temperamentAccentFromKey(t); }
function temperamentBlock(name, title, text, topKey){
  const acc = temperamentAccentFromKey(topKey);
  return `<div class="result-block" style="border-left-color:${acc.color}; background:${acc.bg};">
      <strong>${name || "You"} — ${title}:</strong> <span>${text || "You flex based on the moment."}</span>
    </div>`;
}
function rrAccent(label){
  if(label==="Strong")   return { color:typeColors.Partnership, bg:typeOpac.Partnership };
  if(label==="Moderate") return { color:typeColors.Commitment,  bg:typeOpac.Commitment  };
  return { color:typeColors.Emotional, bg:typeOpac.Emotional };
}
function rrCard(p){
  const acc = rrAccent(p.rrLabel || "Moderate");
  const score = Number.isFinite(p.rrScore) ? p.rrScore : 0;
  return `<div class="result-block" style="border-left-color:${acc.color}; background:${acc.bg};">
      <strong>${p.name || "You"} — Respect &amp; Recognition:</strong> ${p.rrLabel || "Moderate"} (${score}/6)
      <p style="margin:8px 0 0;">${rrStatement(score)}</p>
    </div>`;
}
function rrStatement(score){
  if(score>=5) return "You generally feel affirmed, appreciated, respected, and validated—and you likely offer the same in return.";
  if(score>=3) return "You often feel appreciated and respected, though there may be moments when clearer affirmation would be meaningful.";
  return "You may not consistently feel affirmed or validated; be explicit about the kinds of appreciation that help you feel respected.";
}
function patternColumn(p){
  const key = p.bondingKey || "SteadyConnector";
  const acc = {
    SteadyConnector:{ color: typeColors.Partnership,  bg: typeOpac.Partnership },
    ReassuranceSeeker:{ color: typeColors.Emotional, bg: typeOpac.Emotional },
    IndependentConnector:{ color: typeColors.Intellectual, bg: typeOpac.Intellectual },
    GuardedConnector:{ color: typeColors.Conflict,   bg: typeOpac.Conflict }
  }[key];
  const d = patternDetail[key];
  return `<div class="partner-card"><div class="partner-inner">
      <div class="partner-header">${p.name || "You"}</div>
      <div class="result-block" style="border-left-color:${acc.color}; background:${acc.bg};">
        <p><strong>Connection Type:</strong> ${d.connectionType}</p>
        <p><strong>Strengths:</strong> You ${d.strengths}</p>
        <p><strong>Challenges:</strong> You ${d.challenges}</p>
        <p><strong>Tendencies in Conflict:</strong> ${d.tendencies}</p>
        <p><strong>Coping Skills:</strong> ${d.coping}</p>
      </div>
    </div></div>`;
}
function strategySelfCard(bondingKey){
  const tipsBy = {
    SteadyConnector: [ "Set a five-minute evening check-in: one feeling, one need, one next step.", "When tempted to smooth over, ask yourself: “What do I really need to say?”", "Close loops—agree on the next check-in time before ending tough talks." ],
    ReassuranceSeeker: [ "Ask for one clear reassurance, then take 5–10 calming breaths.", "If you’re spiraling, request a 10-minute reset with a promised return time.", "Use “I feel… I need…” instead of explanations or accusations." ],
    IndependentConnector: [ "Before taking space, reassure with one sentence, then set a clear return time.", "Use a notepad to capture your main point so you don’t avoid the talk.", "Come back with one concrete request and one compromise." ],
    GuardedConnector: [ "Do one daily micro-trust act (keep one small promise).", "Name one safe topic and share a little more than you’re used to.", "Use a short written note to begin hard conversations kindly." ]
  }[bondingKey || "SteadyConnector"];
  const acc = (bondingKey==="ReassuranceSeeker") ? { color: typeColors.Emotional, bg: typeOpac.Emotional }
            : (bondingKey==="IndependentConnector") ? { color: typeColors.Intellectual, bg: typeOpac.Intellectual }
            : (bondingKey==="GuardedConnector") ? { color: typeColors.Conflict, bg: typeOpac.Conflict }
            : { color: typeColors.Partnership, bg: typeOpac.Partnership };
  return `<div class="result-block" style="border-left-color:${acc.color}; background:${acc.bg};">
      <strong>Your Go-To Repair Moves</strong>
      <ul class="results-list" style="margin-top:6px;">${tipsBy.map(t=>`<li>${t}</li>`).join("")}</ul>
    </div>`;
}

/* =========================================================
   PATCH BLOCK — Teaching Copy + Overrides
   ========================================================= */

/* --- Teaching Objects (your exact wording) --- */
// Affection style → APS key
const __AFF_TO_APS = { Playful:"E", Initiative:"S", DeepTalk:"R", Warmth:"A", Support:"U" };

// Compassion & Care (APS temperament)
const __APS_COMPASSION = {
  E: {
    heading: "Sanguine",
    express: `Expressing Love: You're a natural at bringing joy and playfulness into a relationship. Your affection is lighthearted, and you show you care by creating fun moments and lifting the mood. Your actions say, "I'm with you, and life is simply better because we're together."`,
    feel: `Feeling Most Loved: You feel most cherished when the love you give is returned with the same energy and enthusiasm. Laughter, consistent closeness, and affirmation make you feel truly adored and seen.`,
    cautions: `Cautions: Your strong need for fun and validation can sometimes feel overwhelming for a partner with a quieter temperament. If you don't feel like your energy is being matched, you might become restless or discouraged.`,
    try: `Try This: Make a point to balance your playful energy with moments of quiet, calm connection. Instead of waiting for others to guess what you need, practice asking for affirmation directly. It's perfectly okay to say, "I'd really love to hear something encouraging right now."`
  },
  S: {
    heading: "Choleric",
    express: `Expressing Love: You show love through action and initiative. For you, love is a verb. You care for your partner by taking charge—solving problems, creating plans, and protecting the things that matter most to them.`,
    feel: `Feeling Most Loved: You feel deeply honored when your partner steps in to help with a practical task or takes a burden off your shoulders. Acts of service and practical support speak louder than words to you.`,
    cautions: `Cautions: Because you're so action-oriented, you might overlook the need for softer, more emotional connection. This can lead to your partner feeling loved through your actions but not necessarily through tenderness or verbal affection.`,
    try: `Try This: Practice pairing your strong actions with a few simple, verbal affirmations. For example, after you fix something for your partner, you could say, "I did this for you because you're important to me."`
  },
  R: {
    heading: "Melancholy",
    express: `Expressing Love: You express your love through deep thought and meaningful presence. For you, a heartfelt conversation and thoughtful words are the truest forms of affection.`,
    feel: `Feeling Most Loved: You feel most secure when your partner takes the time to truly listen to you. Engaging in a reflective, heart-to-heart dialogue makes you feel understood and deeply cared for.`,
    cautions: `Cautions: Your high standards for yourself and others can sometimes make your partner feel like they can't measure up. Your tendency to over-analyze can also leave you feeling misunderstood if your partner can't follow your line of thought.`,
    try: `Try This: Actively communicate your appreciation, not just your concerns. When you're sharing a thought or a concern, try to add a feeling statement alongside it. For example, "I feel cared for when you listen to me so carefully," rather than just "You're a good listener."`
  },
  A: {
    heading: "Phlegmatic",
    express: `Expressing Love: You show love through your calm and steady presence. Your peaceful tone, gentle touch, and quiet demeanor make your partner feel safe and secure.`,
    feel: `Feeling Most Loved: You feel most cared for when your partner provides a gentle, consistent presence without any pressure. You thrive on a calm, low-key connection that feels reliable and safe.`,
    cautions: `Cautions: Your tendency to avoid conflict can cause you to hide your own needs until they build up into quiet resentment. This can prevent a healthy resolution of issues and leave you feeling unheard.`,
    try: `Try This: Challenge yourself to choose one small need each week to voice clearly and directly. For example, you could say, "It would mean a lot to me if we could have a quiet night in this weekend."`
  },
  U: {
    heading: "Supine",
    express: `Expressing Love: You express your love through consistent service and reliability. Your actions speak volumes, and your message to your partner is always, "You're not alone—I'm with you and I'll be there for you."`,
    feel: `Feeling Most Loved: You feel truly valued when your partner notices your sacrifices, offers to help you in return, and verbally affirms your loyalty and commitment.`,
    cautions: `Cautions: You may have a tendency to suppress your own needs, silently hoping that others will notice what you need without you having to ask. When this goes unrecognized, it can lead to quiet hurt and feeling taken for granted.`,
    try: `Try This: Practice stating a need directly and without apology. It can be as simple as saying, "I'd like to get some rest tonight, so I can't help with that right now." This builds respect and is essential for preventing burnout.`
  }
};

// Respect & Recognition (by score label)
const __RR_TEACHING = {
  Strong: {
    title: "Strong (Score 5–6)",
    result: `Your Result: You have a solid foundation of mutual respect. You generally feel valued, affirmed, and genuinely appreciated, and you have a natural tendency to give that same affirmation to others in return.`,
    looks: `What it looks like: You and your partner likely celebrate each other's contributions and feel a deep sense of alignment in your core values. There's a feeling of being on the same team, where efforts are seen and honored.`,
    cautions: `Cautions: When affirmation comes so naturally, it's easy to take that consistency for granted. You might fall into the trap of using general praise instead of specific, meaningful words.`,
    try: `Try This: Challenge yourself to add more specificity to your affirmations. Instead of simply saying, "Thanks for doing that," try something like, "I really appreciate how you handled that conversation; it showed so much wisdom and care." This kind of specific recognition makes your partner feel truly seen.`
  },
  Moderate: {
    title: "Moderate (Score 3–4)",
    result: `Your Result: You often feel respected, but there are times when you long for clearer appreciation or more intentional recognition.`,
    looks: `What it looks like: You may occasionally wonder if your efforts are truly noticed or if your values are fully shared by your partner. This can lead to moments of uncertainty about your place in the relationship.`,
    cautions: `Cautions: If a need for recognition is not met intentionally, one partner may start to feel quietly undervalued. Over time, this can lead to emotional distance or feelings of being taken for granted.`,
    try: `Try This: Take the initiative to voice one concrete way you'd like to feel honored. It's not nagging; it's providing a clear guide. For example, you could say, "It really helps me feel valued when you say thank you for the small, everyday things, like making dinner or folding the laundry."`
  },
  "Needs Attention": {
    title: "Needs Attention (Score 0–2)",
    result: `Your Result: You may not consistently feel valued, affirmed, or recognized for your contributions or personal beliefs.`,
    looks: `What it looks like: Your efforts may frequently go unnoticed, leaving a space for insecurity and a feeling of being misaligned in your relationship. This can feel like you're putting in a lot of work without your partner seeing or appreciating it.`,
    cautions: `Cautions: If left unspoken, this lack of recognition can create significant emotional distance and resentment, making it feel like you are not on the same side.`,
    try: `Try This: It's time to have a gentle but honest conversation. Approach your partner by sharing your feelings using "I" statements. For example, you could say, "When you notice what I do, I feel seen and respected. Could you please try to name one thing you appreciate each day?" This provides a simple, actionable step that can begin to close the gap.`
  }
};

// Connection Patterns (attachment-rooted)
const __PATTERN_TEACHING = {
  SteadyConnector: {
    title: "Steady Connector",
    result: `Your Result: You have a steady, calm, and harmony-focused connection style. You naturally de-escalate tension and create a safe space for conversation to happen. Your presence is reassuring.`,
    looks: `What it looks like: You're the one who can bring a sense of calm to a heated moment. You prioritize peace and create an environment where your partner feels safe to express themselves without fear of a major argument.`,
    cautions: `Cautions: Your desire for harmony might cause you to smooth over conflict too quickly, leaving important issues unresolved. While you avoid a big fight, the underlying problem may still be there, waiting to resurface later.`,
    try: `Try This: To ensure you're addressing issues fully, try implementing a short, daily check-in. For five minutes, each of you can name one feeling, one need, and one next step before moving on. This simple structure ensures you're addressing the deeper issues without a major conflict.`
  },
  ReassuranceSeeker: {
    title: "Reassurance Seeker",
    result: `Your Result: Your connection style is passionate and driven by closeness. You're quick to notice when something feels off and you work hard to repair the connection.`,
    looks: `What it looks like: You actively fight for clarity and reassurance, wanting to fix things as soon as they feel broken. Your desire to reconnect quickly is a sign of how deeply you value your partner.`,
    cautions: `Cautions: Your urgency for reassurance can sometimes feel overwhelming to your partner, especially if they need a moment to process. If you push for a quick resolution before they're ready, it might create more distance instead of closing it.`,
    try: `Try This: In moments of tension, ask for one clear reassurance from your partner. Then, agree to a short reset with a promised return time. You might say, "Can you just tell me you love me right now? I need twenty minutes to calm down, but I promise I'll be back to talk about this then." This gives both of you what you need.`
  },
  IndependentConnector: {
    title: "Independent Connector",
    result: `Your Result: Your connection style values clarity and personal reflection. You have a natural tendency to de-escalate conflict by stepping back to think carefully.`,
    looks: `What it looks like: When a conversation gets heated, your instinct is to withdraw and process your thoughts. You use this pause to gain clarity and avoid saying something you might regret, which can be very effective.`,
    cautions: `Cautions: If you step away without setting a clear return time, your partner may interpret your pause as withdrawal or disconnection, leading to feelings of abandonment.`,
    try: `Try This: Communicate your need for space with reassurance. Say, "I need about 20 minutes to think about this, but I promise I will come back to talk." By adding a short sentence of reassurance before you step away—like, "I love you, and this is important to me"—you show that you're pausing for the good of the relationship, not to escape it.`
  },
  GuardedConnector: {
    title: "Guarded Connector",
    result: `Your Result: Your connection style is cautious and focuses on building trust slowly. You protect the relationship by avoiding overreactions and showing steady, quiet loyalty.`,
    looks: `What it looks like: You're a rock in the relationship, showing your commitment through steady presence and avoiding drama. This sense of loyalty is a cornerstone of your connection style.`,
    cautions: `Cautions: Your caution can sometimes look like a wall, leaving your partner feeling shut out or unable to get close to you emotionally. Your reluctance to be vulnerable can create a sense of emotional distance.`,
    try: `Try This: To build trust, try engaging in micro-trust exercises. Before a hard conversation, share one safe truth, keep a small promise, or write a short note about something you appreciate. These small acts of vulnerability help your partner feel a little safer, making them more willing to open up to you in return.`
  }
};

/* --- Teaching Renderers --- */
function compassionColumnTeaching(p){
  const name = p.name || "You";
  const mk = (affKey, label)=>{
    const pack = __APS_COMPASSION[ __AFF_TO_APS[affKey] ];
    if(!pack) return "";
    const acc = temperamentAccentFromAffKey(affKey);
    return `
      <div class="result-block" style="border-left-color:${acc.color}; background:${acc.bg};">
        <strong>${pack.heading} — ${label}</strong>
        <p style="margin:.4em 0 0;">${label==="Expressing Love" ? pack.express : pack.feel}</p>
        <p style="margin:.4em 0 0;">${pack.cautions}</p>
        <p style="margin:.4em 0 0;"><em>${pack.try}</em></p>
      </div>
    `;
  };
  const expHtml = (p.expressedTop2||[]).map(k=>mk(k,"Expressing Love")).join("") ||
    `<div class="result-block" style="border-left-color:#4D9DE0;background:rgba(77,157,224,.08);">Make selections earlier to see personalized details.</div>`;
  const desHtml = (p.desiredTop2||[]).map(k=>mk(k,"Feeling Most Loved")).join("") ||
    `<div class="result-block" style="border-left-color:#4D9DE0;background:rgba(77,157,224,.08);">Make selections earlier to see personalized details.</div>`;
  return `
    <div class="partner-card"><div class="partner-inner">
      <div class="partner-header">${name}</div>
      ${expHtml}
      ${desHtml}
    </div></div>
  `;
}
function rrCardTeaching(p){
  const label = p.rrLabel || "Moderate";
  const pack = __RR_TEACHING[label] || __RR_TEACHING["Moderate"];
  const score = Number.isFinite(p.rrScore) ? p.rrScore : 0;
  const acc = rrAccent(label);
  return `
    <div class="result-block" style="border-left-color:${acc.color}; background:${acc.bg};">
      <strong>${pack.title}</strong> <span>(${score}/6)</span>
      <p style="margin:.4em 0 0;">${pack.result}</p>
      <p style="margin:.4em 0 0;">${pack.looks}</p>
      <p style="margin:.4em 0 0;">${pack.cautions}</p>
      <p style="margin:.4em 0 0;"><em>${pack.try}</em></p>
    </div>
  `;
}
function patternColumnTeaching(p){
  const key = p.bondingKey || "SteadyConnector";
  const pack = __PATTERN_TEACHING[key] || __PATTERN_TEACHING.SteadyConnector;
  const acc = {
    SteadyConnector:{ color: typeColors.Partnership,  bg: typeOpac.Partnership },
    ReassuranceSeeker:{ color: typeColors.Emotional, bg: typeOpac.Emotional },
    IndependentConnector:{ color: typeColors.Intellectual, bg: typeOpac.Intellectual },
    GuardedConnector:{ color: typeColors.Conflict,   bg: typeOpac.Conflict }
  }[key] || { color:"#4D9DE0", bg:"rgba(77,157,224,.08)" };
  const name = p.name || "You";
  return `
    <div class="partner-card"><div class="partner-inner">
      <div class="partner-header">${name}</div>
      <div class="result-block" style="border-left-color:${acc.color}; background:${acc.bg};">
        <p><strong>${pack.title}</strong></p>
        <p>${pack.result}</p>
        <p>${pack.looks}</p>
        <p>${pack.cautions}</p>
        <p><em>${pack.try}</em></p>
      </div>
    </div></div>
  `;
}

/* --- Communication conditional text + dropdown --- */
function movingFromConflictCopy(style){
  if(style==="Assertive"){
    return `
      <div class="result-block" style="border-left-color:${typeColors.Emotional}; background:${typeOpac.Emotional};">
        <p>The most successful couples consistently demonstrate a blend of "assertive" and "collaborative/empathetic" communication. Balance your assertive style with collaborative/empathetic style of communication. This involves actively listening and seeking to understand your partner's perspective. This style goes beyond simply hearing words; it's about validating their emotions, even if you don't agree with their viewpoint. This creates a safe space for both partners to be vulnerable and understood.</p>
      </div>
    `;
  }
  if(style==="Collaborative / Empathetic"){
    return `
      <div class="result-block" style="border-left-color:${typeColors.Intellectual}; background:${typeOpac.Intellectual};">
        <p>The most successful couples consistently demonstrate a blend of "assertive" and "collaborative/empathetic" communication. Balance your collaborative/empathetic style with your assertive communication. Assertiveness is about clearly and respectfully expressing your own needs, feelings, and boundaries without attacking or blaming your partner. It's the "I feel..." statement—taking ownership of your emotions and needs, which prevents defensiveness and opens the door for a productive conversation.</p>
      </div>
    `;
  }
  return "";
}
function communicationStyleInfoDropdown(){
  return `
    <div class="dropdown-block" style="text-align:center; margin-top:8px;">
      <button class="btn" onclick="toggleCommInfo()" style="max-width:340px;">
        Understanding the Healthiest Communication Style
      </button>
      <div id="commInfoPanel" class="hidden" style="margin-top:12px; text-align:left;">
        <div class="result-block">
          <p>The most successful couples consistently demonstrate a blend of assertive and collaborative/empathetic communication. While these are often discussed as two separate styles, they are deeply intertwined and represent a healthy, proactive approach to communication.</p>
          <p><strong>Assertive communication</strong> is about clearly and respectfully expressing your own needs, feelings, and boundaries without attacking or blaming your partner. It's the "I feel..." statement—taking ownership of your emotions and needs, which prevents defensiveness and opens the door for a productive conversation.</p>
          <p><strong>Collaborative/empathetic communication</strong> involves actively listening and seeking to understand your partner's perspective. This style goes beyond simply hearing words; it's about validating their emotions, even if you don't agree with their viewpoint. This creates a safe space for both partners to be vulnerable and understood.</p>
          <p>When these two styles are combined, they form a powerful feedback loop. One partner asserts their needs, and the other responds with empathy and a collaborative mindset, and vice versa. This dynamic builds a strong foundation of trust and intimacy, allowing couples to navigate disagreements and challenges as a team rather than as opponents.</p>
        </div>
      </div>
    </div>
  `;
}
function toggleCommInfo(){
  const panel = document.getElementById('commInfoPanel');
  if(panel) panel.classList.toggle('hidden');
}

/* --- Patched renderResults: uses teaching blocks & restores Connection Patterns --- */
function renderResults(p){
  hideAllPages();
  const resultPage=document.getElementById('resultPage'); resultPage.classList.remove('hidden');
  document.getElementById('resultsHeader').textContent = "Your Marriage Connection Profile";
  const mount=document.getElementById('results'); mount.innerHTML="";
  const container=document.createElement('div'); container.id="soloReport"; mount.appendChild(container);

  const addDivider=()=>{ const d=document.createElement('div'); d.className='section-divider'; container.appendChild(d); };
  const addSubDivider=()=>{ const d=document.createElement('div'); d.className='subsection-divider'; container.appendChild(d); };
  const addHTML=(html)=>{ const tmp=document.createElement('div'); tmp.innerHTML=html; while(tmp.firstChild) container.appendChild(tmp.firstChild); };

  /* ---------- Section 1: Your Intimacy Preferences ---------- */
  addDivider();
  addHTML(`<h3 class="section-title">Section 1: Your Intimacy Preferences</h3>
    <div class="intro-text">
      This section is about understanding intimacy—the profound experience of being truly known, deeply connected, and fully cherished. It reveals your unique profile, showing how you naturally express love and how you feel most loved in return.
      <p>Our model organizes intimacy into 12 types across human experience, combining the essential aspects of <em>“being together”</em> (like emotional bonding and spiritual connection) and <em>“doing together”</em> (like shared effort and practical unity). Think of these as a helpful map for your next steps.</p>
    </div>`);

  // Collapsible glossary of all types
  const defsWrap = document.createElement('div'); defsWrap.style.textAlign = 'center';
  const btn = document.createElement('button'); btn.id = 'toggleDefsBtn'; btn.className = 'btn'; btn.style.maxWidth = '260px'; btn.textContent = 'Show All 12 Type Definitions';
  const panel = document.createElement('div'); panel.id = 'allDefs'; panel.className = 'hidden'; panel.style.marginTop='10px'; panel.style.textAlign='left';
  TYPES.forEach(k=>{
    const block = document.createElement('div');
    block.className = 'result-block';
    block.style.borderLeftColor = typeColors[k];
    block.style.background = typeOpac[k];
    block.innerHTML = `<strong>${INTIMACY[k].label}</strong> — ${INTIMACY[k].desc}`;
    panel.appendChild(block);
  });
  btn.onclick = ()=>{ const isHidden = panel.classList.contains('hidden'); panel.classList.toggle('hidden', !isHidden ? true : false); btn.textContent = isHidden ? 'Hide All 12 Type Definitions' : 'Show All 12 Type Definitions'; };
  defsWrap.appendChild(btn); defsWrap.appendChild(panel); container.appendChild(defsWrap);

  addSubDivider();
  addHTML(`<h4 class="subsection-title">Your Core Connection Strengths</h4>
    <div class="verse">“Above all, love each other deeply, because love covers over a multitude of sins.” — 1 Peter 4:8</div>
    <p class="intro-text">These are your most fulfilling and effortless pathways to deeper closeness.</p>`);
  addHTML(typesColumn(p.name, p.coreTypes));

  addSubDivider();
  addHTML(`<h4 class="subsection-title">Your Areas for Growth</h4>
    <div class="verse">“Let us consider how we may spur one another on toward love and good deeds.” — Hebrews 10:24</div>
    <p class="intro-text">These are wonderful opportunities for intentional focus. With a bit of practice and presence, you can deepen connection here.</p>`);
  addHTML(typesColumn(p.name, p.growthTypes));

  addSubDivider();
  addHTML(`<h4 class="subsection-title">Your Untapped Opportunities</h4>
    <div class="verse">“See, I am doing a new thing! … Do you not perceive it?” — Isaiah 43:19</div>
    <p class="intro-text">These aren’t weaknesses—think of them as exciting, untapped gifts to discover. Exploring them can add surprising depth and joy.</p>`);
  addHTML(typesColumn(p.name, p.untappedTypes));

  /* ---------- Section 2: Relational Dynamics ---------- */
  addDivider();
  addHTML(`<h3 class="section-title">Section 2: Relational Dynamics</h3>
    <div class="intro-text">These everyday rhythms shape your connection—how you care, engage socially, share influence, and honor one another.</div>`);

  // Compassion & Care — teaching version
  addSubDivider();
  addHTML(`<h4 class="subsection-title">Compassion & Care</h4>
    <div class="verse">${scripture.compassionCare}</div>
    <p class="intro-text">Express Love and Feel Most Loved, according to your APS temperament in affection (expressed and wanted).</p>`);
  addHTML(compassionColumnTeaching(p));

  // Social Preferences — summary with temperament
  addSubDivider();
  addHTML(`<h4 class="subsection-title">Social Preferences</h4>
    <div class="verse">${scripture.socialEngagement}</div>`);
  addHTML(temperamentBlock(p.name, "Your Social Energy", buildTemperamentText(p.socialTop, p.socialSummary), p.socialTop));

  // Power & Control — summary with temperament
  addSubDivider();
  addHTML(`<h4 class="subsection-title">Power & Control</h4>
    <div class="verse">${scripture.decisionLeadership}</div>`);
  addHTML(temperamentBlock(p.name, "Your Leadership Style", buildTemperamentText(p.decisionTop, p.decisionSummary), p.decisionTop));

  // Respect & Recognition — teaching card
  addSubDivider();
  addHTML(`<h4 class="subsection-title">Respect & Recognition</h4>
    <div class="verse">${scripture.respectRecognition}</div>`);
  addHTML(rrCardTeaching(p));

  /* ---------- Section 3: Connection Patterns (RESTORED) ---------- */
  addDivider();
  addHTML(`<h3 class="section-title">Section 3: Connection Patterns</h3>
    <div class="verse">${scripture.connectionPattern}</div>
    <p class="intro-text">Attachment-rooted patterns for how you reconnect after tension—recast in an engaging, conversational style.</p>`);
  addHTML(patternColumnTeaching(p));

  /* ---------- Section 4: Communication Style (optional) ---------- */
  if (typeof inferCommunicationStyle==="function" && typeof communicationStyleCard==="function"){
    addDivider();
    const style = inferCommunicationStyle(p);
    addHTML(`<h3 class="section-title">Section 4: Communication Style</h3>`);
    addHTML(communicationStyleCard(style)); // your style summary card (existing project code)
    addSubDivider();
    addHTML(`<h4 class="subsection-title">Moving from Conflict to Connection: Communication Style</h4>`);
    const balanced = movingFromConflictCopy(style);
    if (balanced) { addHTML(balanced); } else if (typeof communicationStrategyCard==="function"){ addHTML(communicationStrategyCard(style)); }
    addHTML(communicationStyleInfoDropdown());
  }

  /* ---------- Thank You + Print ---------- */
  addDivider();
  addHTML(`<div class="result-block" style="border-left-color:transparent; background:#fff;">
      <h3 class="thank-title">Thank You</h3>
      <div class="verse">${scripture.thankYou}</div>
      <p class="intro-text">We hope you enjoyed discovering your unique connection patterns. Use these insights as a friendly guide—not labels—to spark great conversations and small, consistent changes.</p>
      <p class="intro-text">To be truly known is to unlock the deepest intimacy—embrace what’s true today and aim courageously for what’s possible tomorrow.</p>
    </div>
    <div style="text-align:center;">
      <button id="downloadPdfBtn" class="btn" style="max-width:260px;">Download PDF</button>
    </div>`);
  const b=document.getElementById('downloadPdfBtn'); if(b) b.onclick=()=>window.print();

  clearState();
}
</script>
</body>
</html>
