<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Discover Your Top Intimacy Needs</title>

  <!-- ✅ Must be BEFORE your <script> -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #fff9f2; color: #1a3c5e; max-width: 800px; margin: auto; padding: 20px; }
    h1,h2,h3 { text-align: center; }
    .question { display: none; }
    .question.active { display: block; }
    .progress { text-align: center; margin: 20px 0; font-weight: bold; color: #888; }
    label { display: block; margin: 10px 0; padding: 10px 15px; background: #f5f5f5; border-radius: 5px; cursor: pointer; }
    input[type="radio"] { margin-right: 10px; }
    button { background: #4d9de0; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 5px; cursor: pointer; margin: 10px; }
    button:hover { background:#3a7fbf; }
    canvas { display: block; margin: 30px auto; max-width: 100%; }
    .description-block { background: #f0f4f9; border-left: 5px solid #4d9de0; padding: 15px; margin-bottom: 20px; }
    .form-section { text-align: center; margin-top: 20px; }
    .form-section input { padding: 10px; margin: 5px; width: 70%; max-width: 300px; display: block; margin: auto; }
    .next-steps-box { background: #e5f8e8; border-left: 6px solid #4CAF50; padding: 15px; margin-top: 30px; }
    #introLogo,#resultsLogo { max-width: 220px; display: block; margin: 0 auto 20px auto; }
    #successMessage { text-align: center; color: green; font-weight: bold; display: none; }
    #introPage { text-align: center; margin-top: 60px; }
    .intro-container { max-width: 600px; margin: 0 auto; background: #fff; border: 2px solid #4d9de0; border-radius: 12px; padding: 30px; box-shadow: 0 8px 25px rgba(0,0,0,0.08);}
    .start-btn { padding: 14px 28px; font-size: 1.2rem; font-weight: bold; color: #fff; background: #4d9de0; border: none; border-radius: 8px; cursor: pointer; }
    .start-btn:hover { background: #3a7fbf; }
    .branding-under-question { text-align:center; font-size:0.9rem; color:#777; margin-top:10px; }
  </style>
</head>
<body>

<!-- ✅ INTRO PAGE -->
<div id="introPage">
  <div class="intro-container">
    <img src="logo.png" id="introLogo" alt="Logo" />
    <h1>What Makes You Feel Deeply Loved?</h1>
    <p>Answer 24 simple questions to reveal the unique ways you connect best—and learn how to create a stronger bond with your spouse.</p>
    <button id="startQuiz" class="start-btn">Start My Quiz</button>
  </div>
</div>

<!-- ✅ QUIZ -->
<div id="quizSection" style="display:none;">
  <h1>What Are Your Top Intimacy Needs?</h1>
  <div class="progress" id="progressText">Question 1 of 24</div>
  <form id="quizForm">
    <div id="quiz"></div>
    <div style="text-align:center;">
      <button type="button" id="backButton" style="display:none;">Back</button>
    </div>
  </form>
</div>

<!-- ✅ RESULTS -->
<div id="resultSection" style="display:none; text-align:center;">
  <img src="logo.png" id="resultsLogo" alt="Logo" />
  <h2>Your Personalized Intimacy Profile</h2>
  <canvas id="chart"></canvas>
  <div id="descriptions"></div>

  <div class="form-section" id="emailSection">
    <input type="text" id="nameInput" placeholder="Your Name" required />
    <input type="email" id="emailInput" placeholder="Your Email" required />
    <button id="sendButton" disabled>Send & Download My Results</button>
  </div>

  <p id="successMessage">✅ Your results have been sent, and your PDF has been downloaded!</p>
</div>

<script>
/* ✅ DATA */
const questions=[ /* same 24 Qs as before */ 
 { q:"I feel most connected when we share spiritual beliefs or pray together.",type:"Spiritual"},
 { q:"I value deep emotional conversations where I feel fully heard and understood.",type:"Emotional"},
 { q:"Having respectful, honest communication—especially during conflict—is important to me.",type:"Conflict"},
 { q:"I enjoy growing intellectually together—learning, reading, or discussing ideas.",type:"Intellectual"},
 { q:"Being physically close (hugs, cuddles, kisses) helps me feel secure.",type:"Physical"},
 { q:"I feel loved when we share sexual closeness and intimacy.",type:"Sexual"},
 { q:"Having shared responsibilities and making decisions as a team matters to me.",type:"Partnership"},
 { q:"I feel safe and connected when we handle tough situations together, not apart.",type:"Conflict"},
 { q:"Spending quality, lighthearted time (laughing, relaxing, having fun) strengthens us.",type:"Affable"},
 { q:"Creating art, music, or other creative experiences together brings me joy.",type:"Creative"},
 { q:"When we manage money together responsibly and transparently, I feel connected.",type:"Financial"},
 { q:"Affectionate touch and presence (like holding hands or snuggling) is very meaningful.",type:"Physical"},
 { q:"I appreciate kind and thoughtful actions done without being asked.",type:"Affable"},
 { q:"Deep heart talks and mutual emotional vulnerability create strong closeness for me.",type:"Emotional"},
 { q:"I feel secure when we set goals together and make decisions as partners.",type:"Partnership"},
 { q:"Shared faith and a common spiritual direction unites us.",type:"Spiritual"},
 { q:"I need to feel sexually desired and enjoyed by my partner.",type:"Sexual"},
 { q:"Playful time, laughing, or even watching a show together helps me connect.",type:"Affable"},
 { q:"It’s important to me that we can talk respectfully even during arguments.",type:"Conflict"},
 { q:"Using money wisely and discussing purchases builds trust and closeness.",type:"Financial"},
 { q:"Collaborating on creative things or solving problems creatively makes me feel alive.",type:"Creative"},
 { q:"I love when we pray together, read Scripture, or serve with shared faith.",type:"Spiritual"},
 { q:"We grow closer when we talk about values, dreams, and big ideas.",type:"Intellectual"},
 { q:"Being emotionally safe and not judged lets me open my heart.",type:"Emotional"}
];
const intimacyDescriptions={Spiritual:"Shared faith and values form the foundation of your bond.",Emotional:"You long to feel emotionally safe and deeply known.",Intellectual:"You enjoy connecting through thoughtful conversations.",Physical:"Being close through touch helps you feel safe and loved.",Sexual:"Sexual intimacy expresses affection, passion, and closeness.",Conflict:"You value staying connected even during disagreements.",Partnership:"You thrive when responsibilities and decisions are shared.",Affable:"Playfulness, kindness, and joy build your connection.",Creative:"Creative activities and imagination inspire closeness.",Financial:"Transparency with money strengthens trust and unity.",Commitment:"Loyalty and security form a foundation for your love.",Recreational:"Fun, leisure, and shared activities grow connection."};
const typeColors={Spiritual:"#FF4D4D",Emotional:"#4D9DE0",Intellectual:"#1A3C5E",Physical:"#FDC57B",Sexual:"#92C9D6",Conflict:"#F67599",Partnership:"#D07E5F",Affable:"#A1B56C",Creative:"#C084FC",Financial:"#7BC1D1",Commitment:"#BAA0F5",Recreational:"#FFE07B"};

const scores={};Object.keys(intimacyDescriptions).forEach(t=>scores[t]=0);let currentQuestion=0;

/* ✅ QUIZ */
document.getElementById("startQuiz").addEventListener("click",()=>{document.getElementById("introPage").style.display="none";document.getElementById("quizSection").style.display="block";showQuestion(currentQuestion);});

function showQuestion(i){
  const quizContainer=document.getElementById("quiz");
  quizContainer.innerHTML='';
  const q=questions[i];
  const div=document.createElement("div");
  div.className="question active";
  div.innerHTML=`<h3>${q.q}</h3>
    ${[5,4,3,2,1].map(v=>`<label><input type="radio" name="q${i}" value="${v}">${["Strongly Agree","Agree","Neutral","Disagree","Strongly Disagree"][5-v]}</label>`).join("")}
    <div class="branding-under-question">happymarriagehappylife.com</div>`;
  quizContainer.appendChild(div);
  document.getElementById("progressText").textContent=`Question ${i+1} of ${questions.length}`;
  document.getElementById("backButton").style.display=i>0?"inline-block":"none";
  div.querySelectorAll("input[type=radio]").forEach(input=>{
    input.addEventListener("change",()=>{scores[q.type]+=parseInt(input.value);currentQuestion++;currentQuestion<questions.length?showQuestion(currentQuestion):(document.getElementById("quizSection").style.display="none",document.getElementById("resultSection").style.display="block",displayResults());});
  });
}

document.getElementById("backButton").addEventListener("click",()=>{if(currentQuestion>0){currentQuestion--;showQuestion(currentQuestion);}});

/* ✅ RESULTS + CHART */
function displayResults() {
  const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
  const priority = sorted.slice(0, 4),
        progress = sorted.slice(4, 8),
        presence = sorted.slice(8, 12);

  function sectionHTML(title, text, items) {
    return `<h3>${title}</h3>
            <p>${text}</p>
            ${items.map(([t, s]) => 
              `<div class="description-block" style="border-left:8px solid ${typeColors[t]}">
                <strong>${t}</strong> (Score: ${s})<br/>${intimacyDescriptions[t]}
              </div>`).join("")}`;
  }

  document.getElementById("descriptions").innerHTML =
    `<p><strong>Explanation of Your Results:</strong> Your Personalized Intimacy Profile is based on the Covenant Intimacy Fulfillment Model™. Each result shows how you naturally prioritize intimacy in your marriage.</p>` +
    sectionHTML("Priority – Your Highest Intimacy Needs", "These are the areas that matter most to you.", priority) +
    sectionHTML("Progress – Areas for Growth", "These are meaningful but may not feel as urgent.", progress) +
    sectionHTML("Presence – Often Overlooked, Still Essential", "Lowest scoring but still important areas.", presence) +
    `<p><strong>Remember:</strong> A thriving marriage values all 12 types of intimacy.</p>`;
}

/* ✅ EMAIL + DEBUG */
const nameInput=document.getElementById("nameInput"),emailInput=document.getElementById("emailInput"),sendButton=document.getElementById("sendButton");
[nameInput,emailInput].forEach(el=>el.addEventListener("input",()=>sendButton.disabled=!(nameInput.value&&emailInput.value)));

sendButton.addEventListener("click",async()=>{
  console.log("✅ Send button clicked");
  try{
    await fetch("https://formspree.io/f/xgvzkwre",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:nameInput.value,email:emailInput.value,scores:JSON.stringify(scores)})});
    console.log("✅ Form submitted");
    await generatePDF();
    console.log("✅ PDF created");
    document.getElementById("successMessage").style.display="block";
  }catch(e){console.error("❌ ERROR:",e);alert("PDF generation failed – check console");}
});

/* ✅ PDF GENERATOR */
async function generatePDF() {
  try {
    console.log("✅ generatePDF started");
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "pt", "a4");

    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const marginX = 30;
    const marginY = 40;
    const usableWidth = pageWidth - marginX * 2;

    // ✅ Load logo
    const logo = new Image();
    logo.src = "logo.png";
    await new Promise((res) => (logo.onload = res));

    // ✅ Cover Page
    pdf.addImage(logo, "PNG", pageWidth / 2 - 90, 70, 180, 90);

    pdf.setFont("helvetica", "bold");
    pdf.setFontSize(24);
    pdf.setTextColor("#1A3C5E");
    pdf.text("Your Personalized Intimacy Profile", pageWidth / 2, 200, { align: "center" });

    pdf.setFont("helvetica", "normal");
    pdf.setFontSize(14);
    pdf.text("Based on the Covenant Intimacy Fulfillment Model™", pageWidth / 2, 225, { align: "center" });

    const userName = document.getElementById("nameInput").value || "Valued User";
    const today = new Date().toLocaleDateString(undefined, { month: "long", day: "numeric", year: "numeric" });
    pdf.setFontSize(12);
    pdf.text(`Prepared for ${userName} – ${today}`, pageWidth / 2, 250, { align: "center" });

    pdf.setFont("helvetica", "bold");
    pdf.setFontSize(14);
    pdf.text("Discover Your Path to Deeper Connection", pageWidth / 2, 300, { align: "center", maxWidth: usableWidth });

    pdf.setFont("helvetica", "normal");
    pdf.setFontSize(12);
    pdf.text(
      "This profile reveals how you uniquely prioritize the 12 types of intimacy God designed for marriage. See your Priority, Progress, and Presence areas—and learn how each one can bring you and your spouse closer than ever.",
      pageWidth / 2,
      330,
      { align: "center", maxWidth: usableWidth }
    );

    pdf.setFont("helvetica", "italic");
    pdf.text(
      "This profile is based on the Covenant Intimacy Fulfillment Model™ (CIFM), developed through the research of Dr. Scott Inman, PhD—founder of the Happy Marriage, Happy Life™ marriage curriculum and resources.",
      pageWidth / 2,
      400,
      { align: "center", maxWidth: usableWidth }
    );

    // ✅ Footer for cover page
    pdf.setFillColor("#4D9DE0");
    pdf.rect(marginX, pageHeight - 50, usableWidth, 40, "F");
    pdf.setTextColor("#FFFFFF");
    pdf.setFont("helvetica", "bold");
    pdf.setFontSize(12);
    pdf.text(
      "HappyMarriageHappyLife.com  |  Helping Couples Build Lasting Love",
      pageWidth / 2,
      pageHeight - 25,
      { align: "center" }
    );

    // ✅ New page for results
    pdf.addPage();
    let yPos = marginY;

    // ✅ Clone the results section WITHOUT email form AND WITHOUT chart
    const resultClone = document.getElementById("resultSection").cloneNode(true);
    const emailForm = resultClone.querySelector("#emailSection");
    if (emailForm) emailForm.remove();
    const chartElement = resultClone.querySelector("#chart");
    if (chartElement) chartElement.remove(); // remove chart completely

    const sections = resultClone.querySelectorAll("h3");
    const pieces = [];

    sections.forEach((section) => {
      const block = document.createElement("div");
      block.dataset.headerColor = "#4D9DE0";
      block.appendChild(section.cloneNode(true));

      let sibling = section.nextElementSibling;
      while (sibling && sibling.tagName !== "H3") {
        block.appendChild(sibling.cloneNode(true));
        sibling = sibling.nextElementSibling;
      }
      pieces.push(block);
    });

    // ✅ Render each section with html2canvas
    for (let piece of pieces) {
      const tempDiv = document.createElement("div");
      tempDiv.style.width = "700px";
      tempDiv.appendChild(piece);
      document.body.appendChild(tempDiv);

      const canvas = await html2canvas(tempDiv, { scale: 2, allowTaint: true, useCORS: true });
      document.body.removeChild(tempDiv);

      const imgData = canvas.toDataURL("image/png");
      const imgProps = pdf.getImageProperties(imgData);
      const imgHeight = (imgProps.height * usableWidth) / imgProps.width;

      // ✅ Page break if needed
      if (yPos + imgHeight > pageHeight - 80) {
        pdf.addPage();
        yPos = marginY;
      }

      pdf.addImage(imgData, "PNG", marginX, yPos, usableWidth, imgHeight);
      yPos += imgHeight + 20;
    }

    // ✅ Final footer
    pdf.setFillColor("#4D9DE0");
    pdf.rect(marginX, pageHeight - 50, usableWidth, 40, "F");
    pdf.setTextColor("#FFFFFF");
    pdf.setFont("helvetica", "bold");
    pdf.setFontSize(12);
    pdf.text(
      "HappyMarriageHappyLife.com  |  Helping Couples Build Lasting Love",
      pageWidth / 2,
      pageHeight - 25,
      { align: "center" }
    );

    setTimeout(() => pdf.save("Intimacy-Results.pdf"), 300);
    console.log("✅ generatePDF finished");
  } catch (err) {
    console.error("❌ PDF ERROR:", err);
  }
}


</script>
</body>
</html>
